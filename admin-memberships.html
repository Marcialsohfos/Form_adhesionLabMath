<!-- admin-memberships.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Lab_Math Admin - Gestion des adhésions</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-members {
            padding: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            color: var(--text-dim);
            font-size: 0.9rem;
        }
        
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.5rem 1.5rem;
            border: 1px solid var(--primary);
            background: transparent;
            color: var(--primary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active,
        .filter-btn:hover {
            background: var(--primary);
            color: var(--dark);
        }
        
        .members-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .members-table th {
            background: rgba(0, 255, 255, 0.2);
            color: var(--primary);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .members-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            color: var(--light);
        }
        
        .members-table tr:hover {
            background: rgba(0, 255, 255, 0.05);
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-en_attente {
            background: rgba(255, 165, 0, 0.2);
            color: orange;
            border: 1px solid orange;
        }
        
        .status-accepte {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 1px solid #00ff00;
        }
        
        .status-refuse {
            background: rgba(255, 0, 0, 0.2);
            color: #ff2a6d;
            border: 1px solid #ff2a6d;
        }
        
        .action-btn {
            padding: 0.3rem 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 0.2rem;
            font-size: 0.8rem;
        }
        
        .btn-view {
            background: var(--primary);
            color: var(--dark);
        }
        
        .btn-accept {
            background: #00ff00;
            color: var(--dark);
        }
        
        .btn-reject {
            background: #ff2a6d;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--dark);
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--primary);
            padding-bottom: 0.5rem;
        }
        
        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
        }
        
        .export-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--dark);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1><span class="gradient-text">Gestion des adhésions</span></h1>
            <p>Administration des demandes d'adhésion à Lab_Math</p>
        </div>
        
        <div class="admin-members">
            <!-- Statistiques -->
            <div class="stats-grid" id="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total demandes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingCount">0</div>
                    <div class="stat-label">En attente</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="acceptedCount">0</div>
                    <div class="stat-label">Acceptées</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="rejectedCount">0</div>
                    <div class="stat-label">Refusées</div>
                </div>
            </div>
            
            <!-- Filtres -->
            <div class="filters">
                <button class="filter-btn active" onclick="filterMembers('all')">Tous</button>
                <button class="filter-btn" onclick="filterMembers('en_attente')">En attente</button>
                <button class="filter-btn" onclick="filterMembers('accepte')">Acceptés</button>
                <button class="filter-btn" onclick="filterMembers('refuse')">Refusés</button>
                <button class="export-btn" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> Exporter CSV
                </button>
            </div>
            
            <!-- Tableau des membres -->
            <table class="members-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom complet</th>
                        <th>Email</th>
                        <th>Téléphone</th>
                        <th>Domaine</th>
                        <th>Date</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="membersTableBody">
                    <!-- Rempli par JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal de détails -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="gradient-text">Détails de la demande</h2>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent">
                <!-- Rempli par JavaScript -->
            </div>
        </div>
    </div>
    
    <script>
        let members = [];
        
        // Charger les données
        async function loadMembers() {
            try {
                const response = await fetch('api/get_memberships.php');
                members = await response.json();
                updateTable();
                updateStats();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Mettre à jour le tableau
        function updateTable(filter = 'all') {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = '';
            
            const filteredMembers = filter === 'all' 
                ? members 
                : members.filter(m => m.statut === filter);
            
            filteredMembers.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.id}</td>
                    <td>${member.prenom} ${member.nom}</td>
                    <td>${member.email}</td>
                    <td>${member.telephone}</td>
                    <td>${member.domaine}</td>
                    <td>${new Date(member.date_soumission).toLocaleDateString()}</td>
                    <td><span class="status-badge status-${member.statut}">${member.statut}</span></td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewMember('${member.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${member.statut === 'en_attente' ? `
                            <button class="action-btn btn-accept" onclick="updateStatus('${member.id}', 'accepte')">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="action-btn btn-reject" onclick="updateStatus('${member.id}', 'refuse')">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Mettre à jour les statistiques
        function updateStats() {
            document.getElementById('totalCount').textContent = members.length;
            document.getElementById('pendingCount').textContent = 
                members.filter(m => m.statut === 'en_attente').length;
            document.getElementById('acceptedCount').textContent = 
                members.filter(m => m.statut === 'accepte').length;
            document.getElementById('rejectedCount').textContent = 
                members.filter(m => m.statut === 'refuse').length;
        }
        
        // Filtrer
        function filterMembers(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            updateTable(filter);
        }
        
        // Voir les détails
        function viewMember(id) {
            const member = members.find(m => m.id === id);
            const modal = document.getElementById('memberModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div style="color: white;">
                    <p><strong>ID:</strong> ${member.id}</p>
                    <p><strong>Nom:</strong> ${member.prenom} ${member.nom}</p>
                    <p><strong>Email:</strong> ${member.email}</p>
                    <p><strong>Téléphone:</strong> ${member.telephone}</p>
                    <p><strong>Date naissance:</strong> ${member.dateNaissance || 'Non spécifié'}</p>
                    <p><strong>Nationalité:</strong> ${member.nationalite || 'Non spécifié'}</p>
                    <p><strong>Adresse:</strong> ${member.adresse || 'Non spécifié'}</p>
                    <p><strong>Ville/Pays:</strong> ${member.ville || ''} ${member.pays || ''}</p>
                    <p><strong>Titre:</strong> ${member.titre}</p>
                    <p><strong>Institution:</strong> ${member.institution || 'Non spécifié'}</p>
                    <p><strong>Domaine:</strong> ${member.domaine}</p>
                    <p><strong>Motivation:</strong> ${member.motivation}</p>
                    <p><strong>Intérêts:</strong> ${member.interets || 'Non spécifié'}</p>
                    <p><strong>Liens:</strong> ${member.liens || 'Non spécifié'}</p>
                    <p><strong>Newsletter:</strong> ${member.newsletter ? 'Oui' : 'Non'}</p>
                    <p><strong>Date soumission:</strong> ${member.date_soumission}</p>
                    <p><strong>Statut:</strong> <span class="status-badge status-${member.statut}">${member.statut}</span></p>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        // Fermer le modal
        function closeModal() {
            document.getElementById('memberModal').classList.remove('active');
        }
        
        // Mettre à jour le statut
        async function updateStatus(id, newStatus) {
            if (!confirm(`Êtes-vous sûr de vouloir ${newStatus === 'accepte' ? 'accepter' : 'refuser'} cette demande ?`)) {
                return;
            }
            
            try {
                const response = await fetch('api/update_status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id, status: newStatus })
                });
                
                if (response.ok) {
                    await loadMembers();
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Exporter en CSV
        function exportToCSV() {
            let csv = "ID,Prénom,Nom,Email,Téléphone,Statut,Date\n";
            
            members.forEach(m => {
                csv += `${m.id},${m.prenom},${m.nom},${m.email},${m.telephone},${m.statut},${m.date_soumission}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `memberships_${new Date().toISOString()}.csv`;
            a.click();
        }
        
        // Charger au démarrage
        loadMembers();
        
        // Actualiser toutes les 30 secondes
        setInterval(loadMembers, 30000);
    </script>

</body>
</html>